# Функциональные требования (Functional Requirements) — RetailHub

Этот документ описывает технические возможности системы, API, структуру данных и логику обработки.

## 1. Системные компоненты

### 1.1. Клиентская часть (Frontend)
1.  **Mobile App (Android/JS):**
    *   Приложение для сотрудников (Консультант / Менеджер).
    *   Авторизация по номеру телефона + паролю.
    *   Работа с Push-уведомлениями (FCM).
    *   Сканер QR-кодов (для проверки).
2.  **Web Client (PWA/Mobile Web):**
    *   Страница для клиентов (без установки приложения).
    *   Открывается по сканированию QR.
    *   Сохраняет сессию в `localStorage`.
    *   Polling статуса заявки (AJAX/Fetch).

### 1.2. Серверная часть (Backend)
1.  **API Gateway (Nginx/Spring Cloud):** Маршрутизация запросов.
2.  **Auth Service:** Выдача JWT-токенов (Access/Refresh).
3.  **Core Services:**
    *   **Users:** Управление сотрудниками, ролями, сменами.
    *   **Stores:** Управление магазинами, отделами, QR-кодами.
    *   **Requests:** Жизненный цикл заявки (State Machine).
    *   **Notifications:** Отправка Push (FCM), история уведомлений.
    *   **Analytics:** Сбор метрик и построение отчетов.

---

## 2. Функциональные возможности (Features)

### 2.1. Управление сотрудниками (Users)
*   **FR-U-01:** Менеджер может создать аккаунт сотрудника, указав роль (`MANAGER` / `CONSULTANT`) и привязав его к магазину.
*   **FR-U-02:** Менеджер может назначить сотруднику компетенции (список отделов), в которых он работает.
*   **FR-U-03:** Система должна поддерживать статусы сотрудника: `OFFLINE` (не на смене), `ACTIVE` (свободен), `BUSY` (занят заявкой).

### 2.2. Управление сменами (Shifts)
*   **FR-S-01:** Консультант может начать смену (`POST /shifts/start`). Статус сотрудника меняется на `ACTIVE`.
*   **FR-S-02:** Консультант может завершить смену (`POST /shifts/end`). Статус сотрудника меняется на `OFFLINE`.
*   **FR-S-03:** Система должна хранить историю смен (дата, длительность).

### 2.3. Работа с QR-кодами
*   **FR-Q-01:** Менеджер может сгенерировать новый QR-код для отдела.
*   **FR-Q-02:** Каждому QR-коду присваивается уникальный UUID-токен (не ID).
*   **FR-Q-03:** Менеджер может деактивировать QR-код (Soft Delete), чтобы остановить поток заявок с него.
*   **FR-Q-04:** При сканировании QR-кода клиентом (`GET /scan/{token}`) система возвращает название отдела.

### 2.4. Обработка заявок (Requests)
*   **FR-R-01:** Клиент создает заявку (`POST /requests`). Статус `CREATED`.
*   **FR-R-02:** Система уведомляет (Push) всех свободных (`ACTIVE`) консультантов данного отдела.
*   **FR-R-03:** Консультант принимает заявку (`POST /assign`). Статус заявки `ASSIGNED`, консультанта `BUSY`.
    *   *Оптимистичная блокировка:* Если заявку уже взяли, второй получает ошибку 409.
*   **FR-R-04:** Клиент опрашивает статус заявки (`Polling`).
*   **FR-R-05:** Клиент может напомнить о себе через 1 минуту (`POST /remind`) → Push назначенному консультанту.
*   **FR-R-06:** Клиент может сменить консультанта через 2 минуты (`POST /reassign`) → Заявка `CREATED`, старый консультант `ACTIVE`.
*   **FR-R-07:** Консультант завершает заявку (`POST /complete`). Статус `COMPLETED`, консультант `ACTIVE`.

### 2.5. Уведомления (Notifications)
*   **FR-N-01:** Система использует Firebase Cloud Messaging (FCM) для доставки Push-уведомлений.
*   **FR-N-02:** Все уведомления дублируются в базу данных (Inbox).
*   **FR-N-03:** Консультант может получить список уведомлений (`GET /notifications`) и отметить как прочитанные.

### 2.6. Аналитика (Analytics)
*   **FR-A-01:** Система собирает метрики: время реакции (Created → Assigned), время обслуживания (Assigned → Completed).
*   **FR-A-02:** Менеджер может получить сводный отчет за период по магазину и по каждому сотруднику.

### 2.7. Эскалация и SLA (Escalation Flows)

**Сценарий A: Игнорирование (никто не берет заявку)**
*   **FR-E-01 (Level 1 - 3 мин):** Если заявка в статусе `CREATED` более 3 минут:
    *   Отправить повторный Push всем свободным консультантам отдела ("Заявка ждет!").
    *   Установить `escalation_level = 1`.
*   **FR-E-02 (Level 2 - 5 минут):** Если заявка в статусе `CREATED` более 5 минут:
    *   Отправить Push-уведомление Менеджеру ("Заявка просрочена!").
    *   Установить `escalation_level = 2`.

**Сценарий B: Медленный консультант (взял, но не дошел)**
*   **FR-E-03 (Reminder - 1 мин):** Клиент может отправить напоминание ("Я жду") через 1 минуту после `ASSIGNED`.
*   **FR-E-04 (Reassign - 3 мин):** Если статус `ASSIGNED` более 3 минут, клиент может нажать "Позвать другого".
    *   Заявка возвращается в `CREATED`.
    *   Предыдущий консультант получает "штраф" в аналитику (потеря заявки).
    *   Менеджер получает уведомление ("Клиент отказался от консультанта").
*   **FR-E-03:** Система должна фиксировать факт эскалации для аналитики (кто из консультантов был на смене и игнорировал).

---

## 3. Нефункциональные требования (NFR)

1.  **Security:**
    *   Все API (кроме публичных `scan`, `requests`) защищены JWT.
    *   Пароли хранятся в виде BCrypt-хешей.
    *   Клиент использует временный `session_token` для доступа к своей заявке.
2.  **Reliability:**
    *   Система должна корректно обрабатывать потерю связи (Push не дошел → есть Inbox).
    *   Данные о сменах и заявках не должны теряться при перезагрузке сервера (PostgreSQL).
3.  **Performance:**
    *   Время ответа API < 200ms.
    *   Время доставки Push-уведомления < 5 секунд (зависит от FCM).

openapi: 3.1.0
info:
  title: RetailHub API
  description: |
    Event-Driven платформа диспетчеризации консультантов в ритейле.
    Клиент сканирует QR-код → создаётся заявка → консультант берёт заявку.

    ## Аутентификация
    Закрытые эндпоинты требуют JWT Bearer-токен:
    ```
    Authorization: Bearer <access_token>
    ```

    ## Роли
    - **MANAGER** — управление магазином, отделами, консультантами, аналитика
    - **CONSULTANT** — приём и обработка заявок, управление сменами

    ## Публичные эндпоинты (без токена)
    - Сканирование QR-кода
    - Создание заявки
    - Polling статуса заявки клиентом
    - Напоминание консультанту
    - Смена консультанта
  version: 1.0.0
  contact:
    name: RetailHub Team

servers:
  - url: http://localhost:8080/api/v1
    description: Local development
  - url: https://api.retailhub.ru/api/v1
    description: Production

tags:
  - name: Auth
    description: Аутентификация и JWT-токены
  - name: Users
    description: Управление сотрудниками (MANAGER)
  - name: Stores
    description: Магазин и отделы (MANAGER)
  - name: QR Codes
    description: QR-коды (MANAGER + публичный scan)
  - name: Requests
    description: Заявки на обслуживание
  - name: Shifts
    description: Смены консультантов
  - name: Notifications
    description: Push-уведомления и inbox
  - name: Devices
    description: Регистрация FCM-токенов
  - name: Analytics
    description: Дашборд и статистика (MANAGER)

security:
  - BearerAuth: []

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  schemas:

    # --- Enums ---

    Role:
      type: string
      enum: [MANAGER, CONSULTANT]

    UserStatus:
      type: string
      enum: [OFFLINE, ACTIVE, BUSY]
      description: |
        OFFLINE — не на смене, ACTIVE — свободен, BUSY — обслуживает клиента

    RequestStatus:
      type: string
      enum: [CREATED, ASSIGNED, COMPLETED]
      description: |
        CREATED → ASSIGNED → COMPLETED
        ASSIGNED → CREATED (клиент нажал "Сменить")

    # --- Auth ---

    LoginRequest:
      type: object
      required: [phone_number, password]
      properties:
        phone_number:
          type: string
          description: Номер телефона
          example: "+79991234567"
        password:
          type: string
          format: password
          minLength: 6

    TokenResponse:
      type: object
      properties:
        access_token:
          type: string
          description: JWT access-токен (15 мин)
        refresh_token:
          type: string
          description: JWT refresh-токен (7 дней)
        token_type:
          type: string
          example: Bearer
        expires_in:
          type: integer
          description: Время жизни access-токена (секунды)
          example: 900

    RefreshRequest:
      type: object
      required: [refresh_token]
      properties:
        refresh_token:
          type: string

    # --- User ---

    UserProfile:
      type: object
      properties:
        id:
          type: string
          format: uuid
        store_id:
          type: string
          format: uuid
        phone_number:
          type: string
        first_name:
          type: string
        last_name:
          type: string
        role:
          $ref: '#/components/schemas/Role'
        current_status:
          $ref: '#/components/schemas/UserStatus'
        departments:
          type: array
          items:
            $ref: '#/components/schemas/DepartmentShort'
          description: Отделы, в которых сотрудник компетентен
        created_at:
          type: string
          format: date-time

    DepartmentShort:
      type: object
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string

    CreateUserRequest:
      type: object
      required: [phone_number, password, first_name, last_name, role]
      properties:
        phone_number:
          type: string
          description: Номер телефона для логина. Уникальный.
          example: "+79991234567"
        password:
          type: string
          format: password
          minLength: 6
        first_name:
          type: string
          maxLength: 100
          example: Иван
        last_name:
          type: string
          maxLength: 100
          example: Петров
        role:
          $ref: '#/components/schemas/Role'
        department_ids:
          type: array
          items:
            type: string
            format: uuid
          description: Отделы для назначения компетенций

    UpdateUserRequest:
      type: object
      properties:
        first_name:
          type: string
          maxLength: 100
        last_name:
          type: string
          maxLength: 100

    AssignDepartmentsRequest:
      type: object
      required: [department_ids]
      properties:
        department_ids:
          type: array
          items:
            type: string
            format: uuid
          description: Список отделов (полная замена текущих)

    # --- Store ---

    Store:
      type: object
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
        address:
          type: string
        timezone:
          type: string
          example: Europe/Moscow
        created_at:
          type: string
          format: date-time

    UpdateStoreRequest:
      type: object
      properties:
        name:
          type: string
        address:
          type: string
        timezone:
          type: string
          example: Europe/Moscow

    # --- Department ---

    Department:
      type: object
      properties:
        id:
          type: string
          format: uuid
        store_id:
          type: string
          format: uuid
        name:
          type: string
        created_at:
          type: string
          format: date-time

    CreateDepartmentRequest:
      type: object
      required: [name]
      properties:
        name:
          type: string
          maxLength: 255
          example: Телевизоры

    UpdateDepartmentRequest:
      type: object
      properties:
        name:
          type: string
          maxLength: 255

    # --- QR Code ---

    QrCode:
      type: object
      properties:
        id:
          type: string
          format: uuid
        department_id:
          type: string
          format: uuid
        department_name:
          type: string
        token:
          type: string
          format: uuid
        scan_url:
          type: string
          format: uri
          example: https://retailhub.ru/scan/550e8400-e29b-41d4-a716-446655440000
        label:
          type: string
        is_active:
          type: boolean
        created_at:
          type: string
          format: date-time

    CreateQrCodeRequest:
      type: object
      required: [department_id]
      properties:
        department_id:
          type: string
          format: uuid
        label:
          type: string
          maxLength: 255
          example: "Стеллаж 3, ряд B"

    # --- Request ---

    ServiceRequest:
      type: object
      properties:
        id:
          type: string
          format: uuid
        store_id:
          type: string
          format: uuid
        department_id:
          type: string
          format: uuid
        department_name:
          type: string
        assigned_user:
          $ref: '#/components/schemas/AssignedConsultant'
        status:
          $ref: '#/components/schemas/RequestStatus'
        client_session_token:
          type: string
          format: uuid
        created_at:
          type: string
          format: date-time
        assigned_at:
          type: string
          format: date-time
        completed_at:
          type: string
          format: date-time

    AssignedConsultant:
      type: object
      properties:
        first_name:
          type: string
        last_name:
          type: string

    CreateRequestRequest:
      type: object
      required: [qr_token]
      properties:
        qr_token:
          type: string
          format: uuid

    ClientRequestView:
      type: object
      description: Вид заявки для клиента (polling)
      properties:
        id:
          type: string
          format: uuid
        status:
          $ref: '#/components/schemas/RequestStatus'
        department_name:
          type: string
        consultant_name:
          type: string
          description: Имя консультанта (при ASSIGNED)
        can_remind:
          type: boolean
          description: true если прошло >= 1 мин - кнопка "Напомнить"
        can_reassign:
          type: boolean
          description: true если прошло >= 2 мин - кнопка "Сменить"
        created_at:
          type: string
          format: date-time
        assigned_at:
          type: string
          format: date-time

    # --- Shift ---

    Shift:
      type: object
      properties:
        id:
          type: string
          format: uuid
        user_id:
          type: string
          format: uuid
        user_name:
          type: string
          description: "Имя Фамилия"
        started_at:
          type: string
          format: date-time
        ended_at:
          type: string
          format: date-time
          description: NULL = смена ещё активна

    # --- Notification ---

    Notification:
      type: object
      properties:
        id:
          type: string
          format: uuid
        title:
          type: string
        body:
          type: string
        type:
          type: string
          description: "REQUEST_NEW, REQUEST_ASSIGNED, REQUEST_REMINDER, SHIFT_REMINDER"
        payload:
          type: object
        is_read:
          type: boolean
        created_at:
          type: string
          format: date-time

    # --- Device ---

    RegisterDeviceRequest:
      type: object
      required: [fcm_token]
      properties:
        fcm_token:
          type: string
          maxLength: 500
        device_info:
          type: string
          maxLength: 255
          example: "Samsung Galaxy S24, Android 15"

    Device:
      type: object
      properties:
        id:
          type: string
          format: uuid
        fcm_token:
          type: string
        device_info:
          type: string
        created_at:
          type: string
          format: date-time

    # --- Analytics ---

    DashboardResponse:
      type: object
      properties:
        total_requests_today:
          type: integer
        completed_requests_today:
          type: integer
        active_consultants:
          type: integer
        avg_reaction_time_seconds:
          type: number
          format: double
          description: Среднее время реакции (сек)
        avg_service_time_seconds:
          type: number
          format: double
          description: Среднее время обслуживания (сек)

    ConsultantStats:
      type: object
      properties:
        user_id:
          type: string
          format: uuid
        first_name:
          type: string
        last_name:
          type: string
        total_requests:
          type: integer
        completed_requests:
          type: integer
        avg_reaction_seconds:
          type: number
          format: double
        avg_service_seconds:
          type: number
          format: double
        total_work_minutes:
          type: integer
          description: Время на смене (минуты)
        total_busy_minutes:
          type: integer
          description: Время в BUSY (обслуживание)
        total_idle_minutes:
          type: integer
          description: Время простоя (ACTIVE, без заявок)

    ConsultantDetailedStats:
      type: object
      properties:
        consultant:
          $ref: '#/components/schemas/ConsultantStats'
        daily_breakdown:
          type: array
          items:
            type: object
            properties:
              date:
                type: string
                format: date
              requests_completed:
                type: integer
              avg_reaction_seconds:
                type: number
                format: double
              work_minutes:
                type: integer

    # --- Common ---

    ErrorResponse:
      type: object
      properties:
        error:
          type: string
          example: REQUEST_ALREADY_ASSIGNED
        message:
          type: string
          example: Заявка уже взята другим консультантом
        timestamp:
          type: string
          format: date-time

    PageResponse:
      type: object
      properties:
        content:
          type: array
          items: {}
        page:
          type: integer
        size:
          type: integer
        total_elements:
          type: integer
        total_pages:
          type: integer

# ============================================================================
# PATHS
# ============================================================================
paths:

  # --- AUTH ---

  /auth/login:
    post:
      tags: [Auth]
      summary: Логин по номеру телефона
      description: Возвращает access (15 мин) + refresh (7 дней) токены.
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LoginRequest'
      responses:
        '200':
          description: Токены
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TokenResponse'
        '401':
          description: Неверные данные
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /auth/refresh:
    post:
      tags: [Auth]
      summary: Обновить access-токен
      description: Мобилка автоматически обновляет токен без повторного логина.
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RefreshRequest'
      responses:
        '200':
          description: Новые токены
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TokenResponse'
        '401':
          description: Refresh-токен невалиден
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /auth/me:
    get:
      tags: [Auth]
      summary: Профиль текущего пользователя
      description: Приложение вызывает при запуске — получает роль, магазин, отделы.
      responses:
        '200':
          description: Профиль
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserProfile'

  # --- USERS (MANAGER) ---

  /users:
    post:
      tags: [Users]
      summary: Создать аккаунт сотрудника
      description: Менеджер создаёт аккаунт в своём магазине. Можно сразу назначить отделы.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateUserRequest'
      responses:
        '201':
          description: Создан
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserProfile'
        '400':
          description: Валидация (телефон занят)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '403':
          description: Нет прав
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

    get:
      tags: [Users]
      summary: Список сотрудников магазина
      parameters:
        - name: role
          in: query
          schema:
            $ref: '#/components/schemas/Role'
        - name: page
          in: query
          schema:
            type: integer
            default: 0
        - name: size
          in: query
          schema:
            type: integer
            default: 20
      responses:
        '200':
          description: Список
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/PageResponse'
                  - type: object
                    properties:
                      content:
                        type: array
                        items:
                          $ref: '#/components/schemas/UserProfile'

  /users/{userId}:
    parameters:
      - name: userId
        in: path
        required: true
        schema:
          type: string
          format: uuid

    get:
      tags: [Users]
      summary: Профиль сотрудника
      responses:
        '200':
          description: Профиль
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserProfile'
        '404':
          description: Не найден
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

    put:
      tags: [Users]
      summary: Обновить сотрудника
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateUserRequest'
      responses:
        '200':
          description: Обновлён
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserProfile'

    delete:
      tags: [Users]
      summary: Удалить сотрудника
      description: Полное удаление из БД. Связанные смены удаляются каскадно.
      responses:
        '204':
          description: Удалён

  /users/{userId}/departments:
    put:
      tags: [Users]
      summary: Назначить отделы (компетенции)
      description: Полная замена списка отделов.
      parameters:
        - name: userId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AssignDepartmentsRequest'
      responses:
        '200':
          description: Обновлено
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserProfile'

  # --- STORES (MANAGER) ---

  /stores/my:
    get:
      tags: [Stores]
      summary: Мой магазин
      responses:
        '200':
          description: Магазин
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Store'

    put:
      tags: [Stores]
      summary: Обновить магазин
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateStoreRequest'
      responses:
        '200':
          description: Обновлён
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Store'

  /stores/my/departments:
    get:
      tags: [Stores]
      summary: Список отделов
      responses:
        '200':
          description: Отделы
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Department'

    post:
      tags: [Stores]
      summary: Создать отдел
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateDepartmentRequest'
      responses:
        '201':
          description: Создан
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Department'

  /departments/{departmentId}:
    parameters:
      - name: departmentId
        in: path
        required: true
        schema:
          type: string
          format: uuid

    put:
      tags: [Stores]
      summary: Обновить отдел
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateDepartmentRequest'
      responses:
        '200':
          description: Обновлён
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Department'

    delete:
      tags: [Stores]
      summary: Удалить отдел
      description: Каскадно удалит QR-коды и привязки консультантов.
      responses:
        '204':
          description: Удалён

  # --- QR CODES ---

  /qr-codes:
    post:
      tags: [QR Codes]
      summary: Сгенерировать QR-код (MANAGER)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateQrCodeRequest'
      responses:
        '201':
          description: Создан
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/QrCode'

    get:
      tags: [QR Codes]
      summary: Список QR-кодов (MANAGER)
      parameters:
        - name: department_id
          in: query
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Список
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/QrCode'

  /qr-codes/{qrCodeId}:
    delete:
      tags: [QR Codes]
      summary: Деактивировать QR-код (MANAGER)
      parameters:
        - name: qrCodeId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '204':
          description: Деактивирован

  /qr-codes/scan/{token}:
    get:
      tags: [QR Codes]
      summary: Сканирование QR (публичный)
      description: Клиент попадает сюда после скана. Возвращает инфо об отделе.
      security: []
      parameters:
        - name: token
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Инфо о точке
          content:
            application/json:
              schema:
                type: object
                properties:
                  department_name:
                    type: string
                  store_name:
                    type: string
                  is_valid:
                    type: boolean
        '404':
          description: QR не найден
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  # --- REQUESTS ---

  /requests:
    post:
      tags: [Requests]
      summary: Создать заявку (публичный, клиент через QR)
      description: |
        Флоу:
        1. GET /qr-codes/scan/{token} — инфо об отделе
        2. POST /requests — создание заявки
        3. GET /requests/{id}?session={token} — polling статуса
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateRequestRequest'
      responses:
        '201':
          description: Заявка создана
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ClientRequestView'
        '400':
          description: QR невалиден
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

    get:
      tags: [Requests]
      summary: Список заявок (MANAGER/CONSULTANT)
      description: |
        Консультант видит CREATED-заявки своих отделов.
        Менеджер видит все заявки магазина.
      parameters:
        - name: status
          in: query
          schema:
            $ref: '#/components/schemas/RequestStatus'
        - name: department_id
          in: query
          schema:
            type: string
            format: uuid
        - name: date_from
          in: query
          schema:
            type: string
            format: date
        - name: date_to
          in: query
          schema:
            type: string
            format: date
        - name: page
          in: query
          schema:
            type: integer
            default: 0
        - name: size
          in: query
          schema:
            type: integer
            default: 20
      responses:
        '200':
          description: Заявки
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/PageResponse'
                  - type: object
                    properties:
                      content:
                        type: array
                        items:
                          $ref: '#/components/schemas/ServiceRequest'

  /requests/{requestId}:
    get:
      tags: [Requests]
      summary: Статус заявки (polling клиентом, публичный)
      description: |
        Ответ включает can_remind (>= 1 мин) и can_reassign (>= 2 мин).
      security: []
      parameters:
        - name: requestId
          in: path
          required: true
          schema:
            type: string
            format: uuid
        - name: session
          in: query
          required: true
          schema:
            type: string
            format: uuid
          description: client_session_token
      responses:
        '200':
          description: Статус
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ClientRequestView'
        '403':
          description: Неверный session-токен
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /requests/{requestId}/assign:
    post:
      tags: [Requests]
      summary: Взять заявку (CONSULTANT)
      description: |
        Если уже взята — 409. Побочные эффекты:
        - Заявка → ASSIGNED, консультант → BUSY
        - Kafka → RequestAssigned
      parameters:
        - name: requestId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Принята
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ServiceRequest'
        '409':
          description: Уже взята другим
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /requests/{requestId}/complete:
    post:
      tags: [Requests]
      summary: Завершить обслуживание (CONSULTANT)
      description: Заявка → COMPLETED, консультант → ACTIVE.
      parameters:
        - name: requestId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Завершена
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ServiceRequest'

  /requests/{requestId}/remind:
    post:
      tags: [Requests]
      summary: Напомнить консультанту (клиент, >= 1 мин)
      description: Отправляет push-уведомление назначенному консультанту.
      security: []
      parameters:
        - name: requestId
          in: path
          required: true
          schema:
            type: string
            format: uuid
        - name: session
          in: query
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Отправлено
        '400':
          description: Рано (< 1 мин) или не ASSIGNED
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /requests/{requestId}/reassign:
    post:
      tags: [Requests]
      summary: Сменить консультанта (клиент, >= 2 мин)
      description: Заявка → CREATED, предыдущий консультант → ACTIVE. Новый поиск.
      security: []
      parameters:
        - name: requestId
          in: path
          required: true
          schema:
            type: string
            format: uuid
        - name: session
          in: query
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Возвращена в очередь
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ClientRequestView'
        '400':
          description: Рано (< 2 мин) или не ASSIGNED
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  # --- SHIFTS ---

  /shifts/start:
    post:
      tags: [Shifts]
      summary: Начать смену (CONSULTANT)
      description: Создаёт запись смены. Консультант → ACTIVE.
      responses:
        '201':
          description: Смена начата
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Shift'
        '409':
          description: Уже на смене
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /shifts/end:
    post:
      tags: [Shifts]
      summary: Закончить смену (CONSULTANT)
      description: Ставит ended_at. Консультант → OFFLINE.
      responses:
        '200':
          description: Смена завершена
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Shift'
        '400':
          description: Нет активной смены
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /shifts/active:
    get:
      tags: [Shifts]
      summary: Кто сейчас на смене (MANAGER)
      responses:
        '200':
          description: Активные смены
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Shift'

  /shifts/my:
    get:
      tags: [Shifts]
      summary: Мои смены (CONSULTANT)
      parameters:
        - name: date_from
          in: query
          schema:
            type: string
            format: date
        - name: date_to
          in: query
          schema:
            type: string
            format: date
      responses:
        '200':
          description: Мои смены
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Shift'

  # --- NOTIFICATIONS ---

  /notifications:
    get:
      tags: [Notifications]
      summary: Inbox уведомлений
      parameters:
        - name: is_read
          in: query
          schema:
            type: boolean
        - name: page
          in: query
          schema:
            type: integer
            default: 0
        - name: size
          in: query
          schema:
            type: integer
            default: 20
      responses:
        '200':
          description: Уведомления
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/PageResponse'
                  - type: object
                    properties:
                      content:
                        type: array
                        items:
                          $ref: '#/components/schemas/Notification'

  /notifications/{notificationId}/read:
    post:
      tags: [Notifications]
      summary: Отметить прочитанным
      parameters:
        - name: notificationId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '204':
          description: Отмечено

  # --- DEVICES ---

  /devices:
    post:
      tags: [Devices]
      summary: Регистрация FCM-токена
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RegisterDeviceRequest'
      responses:
        '201':
          description: Зарегистрировано
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Device'

  /devices/{deviceId}:
    delete:
      tags: [Devices]
      summary: Удалить устройство (при логауте)
      parameters:
        - name: deviceId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '204':
          description: Удалено

  # --- ANALYTICS (MANAGER) ---

  /analytics/dashboard:
    get:
      tags: [Analytics]
      summary: Дашборд менеджера
      description: Сводка за сегодня.
      responses:
        '200':
          description: Дашборд
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DashboardResponse'

  /analytics/consultants:
    get:
      tags: [Analytics]
      summary: Статистика по консультантам
      description: Заявки, время работы/простоя, реакции за период.
      parameters:
        - name: date_from
          in: query
          required: true
          schema:
            type: string
            format: date
        - name: date_to
          in: query
          required: true
          schema:
            type: string
            format: date
      responses:
        '200':
          description: Статистика
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/ConsultantStats'

  /analytics/consultants/{userId}:
    get:
      tags: [Analytics]
      summary: Детальная статистика консультанта
      description: С разбивкой по дням.
      parameters:
        - name: userId
          in: path
          required: true
          schema:
            type: string
            format: uuid
        - name: date_from
          in: query
          required: true
          schema:
            type: string
            format: date
        - name: date_to
          in: query
          required: true
          schema:
            type: string
            format: date
      responses:
        '200':
          description: Детальная статистика
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ConsultantDetailedStats'

  /analytics/requests:
    get:
      tags: [Analytics]
      summary: История заявок
      parameters:
        - name: status
          in: query
          schema:
            $ref: '#/components/schemas/RequestStatus'
        - name: department_id
          in: query
          schema:
            type: string
            format: uuid
        - name: assigned_user_id
          in: query
          schema:
            type: string
            format: uuid
        - name: date_from
          in: query
          schema:
            type: string
            format: date
        - name: date_to
          in: query
          schema:
            type: string
            format: date
        - name: page
          in: query
          schema:
            type: integer
            default: 0
        - name: size
          in: query
          schema:
            type: integer
            default: 20
      responses:
        '200':
          description: Заявки
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/PageResponse'
                  - type: object
                    properties:
                      content:
                        type: array
                        items:
                          $ref: '#/components/schemas/ServiceRequest'
